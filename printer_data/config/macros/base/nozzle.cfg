[gcode_macro CLEAN_NOZZLE]
description: Clean nozzle using configurable temperature and wipe patterns
gcode:
    SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE

    # Get cleaning temperature - use EXTRUDER param if available, otherwise default to 200
    {% set NOZZLE_TEMP = params.EXTRUDER|default(params.TEMP|default(150))|int %}
    {% set wipes = params.WIPES|default(5)|int %}

    # Homes the printer, sets absolute positioning, and updates the Stealthburner LEDs.
    #STATUS_HOMING
    # Check homing status and home if needed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                             # Full home if not already homed
    {% elif 'z' not in printer.toolhead.homed_axes %}
        G28 Z                           # Home Z if only Z is unhomed
    {% endif %}

    # Perform leveling only if needed (not already applied)
    {% if ('z_tilt' in printer and not printer.z_tilt.applied) or ('quad_gantry_level' in printer and not printer.quad_gantry_level.applied) %}
        # Use custom GANTRY_LEVELING macro if available, otherwise fallback to standard methods
        {% if printer.configfile.config['gcode_macro GANTRY_LEVELING'] is defined %}
            #STATUS_LEVELING                                        # Sets SB-LEDs to leveling-mode
            M117 Gantry Leveling...                                 # Display gantry leveling status
            GANTRY_LEVELING                                         # Performs the appropriate leveling method (QGL or Z_TILT)
        {% else %}
            # Fallback to traditional method if GANTRY_LEVELING doesn't exist
            {% if 'z_tilt' in printer and not printer.z_tilt.applied %}
                #STATUS_LEVELING                                  # Sets SB-LEDs to leveling-mode
                M117 Z-tilt...                                    # Display Z-tilt adjustment
                Z_TILT_ADJUST                                     # Levels the buildplate via z_tilt_adjust
            {% elif 'quad_gantry_level' in printer and not printer.quad_gantry_level.applied %}
                #STATUS_LEVELING                                  # Sets SB-LEDs to leveling-mode
                M117 QGL...                                       # Display QGL status
                QUAD_GANTRY_LEVEL                                 # Levels the gantry
            {% endif %}
        {% endif %}
    {% else %}
        M117 Leveling already applied - skipping
        {action_respond_info("Gantry leveling skipped - already applied")}
    {% endif %}

    # Conditional check to ensure Z is homed after leveling procedures
    # Keep this for macro independence - allows CLEAN_NOZZLE to be run standalone
    {% if 'z' not in printer.toolhead.homed_axes %}
        #STATUS_HOMING                                        # Sets SB-LEDs to homing-mode
        M117 Z homing                                         # Display Z homing status
        G28 Z                                                 # Home Z if needed after leveling
    {% endif %}

    # Now proceed with nozzle cleaning sequence
    G90                                        # Absolute positioning
    G1 X324 Y357 Z10 F7800                     # Move to cleaning position with safe Z height

    #STATUS_HEATING
    M117 Heating nozzle...
    {action_respond_info("Heating nozzle to %sÂ°C" % (NOZZLE_TEMP))}
    M109 S{NOZZLE_TEMP}                        # Heat and wait

    G91                                        # Relative positioning
    G90                                        # Back to absolute positioning
    M106 S127                                  # Fan at 50%

    #STATUS_CLEANING
    M117 Cleaning nozzle

    # Combined cleaning pattern
    G1 X324 Y357 F7800                         # Move to start position
    G1 Z0.2 F300                               # Lower to cleaning height (0.2mm)

    # Main cleaning sequence
    {% for wipe in range(wipes) %}              # Configurable wipe cycles
        # Straight wipes (now moving along X-axis)
        G1 X352 Y357 F7800                     # Forward wipe (right)
        G1 X324 Y357 F7800                     # Backward wipe (left)

        # Zigzag pattern
        G1 Y362 X332 F7800                     # Diagonal forward
        G1 Y360 X336 F7800                     # Middle point (changed from Y359.5)
        G1 Y357 X352 F7800                     # Diagonal back

        # Constant pressure cleaning
        G1 Y362 X324 F7800                     # Forward wipe
        G1 Y357 X332 F7800                     # Return wipe
    {% endfor %}

    # Final cleanup moves
    G1 Y363 X324 F7800                         # Move away from cleaning area
    M400                                       # Wait for moves to complete
    M117 Clean Complete
    M107                                       # Turn off fan

    # Return to safe position
    G91                                        # Relative positioning
    G1 Z10 F300                                # Raise nozzle
    G90                                        # Absolute positioning
    G28 Z                                      # Home Z

    #STATUS_READY
    # Only turn off heaters if we're not in a print
    {% if printer.idle_timeout.state == "Idle" %}
        TURN_OFF_HEATERS
        {action_respond_info("Cleaning complete - heaters turned off (idle state)")}
    {% else %}
        {action_respond_info("Cleaning complete - heaters maintained (printing state)")}
    {% endif %}

    RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE